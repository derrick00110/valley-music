<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å±±è°·éŸ³ä¹æ’è¯¾ç³»ç»Ÿ V11.2</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyA2gGU0vqd1Y2-qZlpSjdz8S9p7A2o_0nU",
            authDomain: "vally-dab25.firebaseapp.com",
            projectId: "vally-dab25",
            storageBucket: "vally-dab25.firebasestorage.app",
            messagingSenderId: "880965654686",
            appId: "1:880965654686:web:3fac308b13bbc94664038f",
            measurementId: "G-QJR8B1XRZW"
        };

        // --- 2. WxPusher é…ç½® ---
        const WXPUSHER_APP_TOKEN = "AT_n4lrCyl9JiOU6tpovHrl1eilFoWpyQEc"; 
        const ADMIN_UID = "UID_ib775oGXFfdMovh9EqjzcGOApr2B"; 

        // --- 3. å¸¸é‡ ---
        const DEFAULT_TEACHERS = [
            "éƒ­è€å¸ˆ:UID_vM4oGlev5j2ynmknAY41LJpOe3wV", 
            "é’±è€å¸ˆ:UID_TCwmvSlK0L3JI41QWe5dEamfikVb", 
            "é»„è€å¸ˆ:UID_Cdo57nIe8xoMfB1c1MXkgJVJrjZH",
            "åˆ˜è€å¸ˆ"
        ];
        
        const COURSE_OPTIONS = [
            "é’¢ç´æ­£å¼è¯¾", "é’¢ç´ä½“éªŒè¯¾",
            "å£°ä¹æ­£å¼è¯¾", "å£°ä¹ä½“éªŒè¯¾",
            "æ¶å­é¼“æ­£å¼è¯¾", "æ¶å­é¼“ä½“éªŒè¯¾",
            "å‰ä»–æ­£å¼è¯¾", "å‰ä»–ä½“éªŒè¯¾"
        ];

        const INITIAL_SETTINGS = { startHour: 9, endHour: 22 };

        // --- åˆå§‹åŒ– ---
        let db, auth;
        let isFirebaseReady = false;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            isFirebaseReady = true;
        } catch (e) { console.error("Firebase Init Error", e); }

        const { useState, useEffect, useMemo, useRef } = React;

        // --- æ¨é€é€»è¾‘ ---
        const sendWxPush = async (courseData, type = 'add', teacherUid = null) => {
            if (!WXPUSHER_APP_TOKEN) return { success: false };
            const uids = new Set();
            if (ADMIN_UID) uids.add(ADMIN_UID); 
            if (teacherUid) uids.add(teacherUid); 
            const targetUids = Array.from(uids);
            if (targetUids.length === 0) return { success: false };

            let content = "";
            if (courseData === 'test') {
                content = "ğŸ‰ **æµ‹è¯•æˆåŠŸï¼**\næ­å–œï¼Œæ‚¨çš„ç³»ç»Ÿå·²æˆåŠŸè¿æ¥åˆ°å¾®ä¿¡æ¨é€æœåŠ¡ã€‚";
            } else {
                const d = new Date(courseData.date);
                const weekDay = d.toLocaleDateString('zh-CN', {weekday:'long'});
                let title = 'ğŸ“… æ–°å¢æ’è¯¾é€šçŸ¥';
                let color = '#2ecc71'; 
                let action = 'å·²å®‰æ’';
                if (type === 'edit') { title = 'ğŸ“ è¯¾ç¨‹ä¿®æ”¹é€šçŸ¥'; color = '#f39c12'; action = 'å·²ä¿®æ”¹'; }
                else if (type === 'delete') { title = 'ğŸ—‘ï¸ åˆ è¯¾é€šçŸ¥'; color = '#e74c3c'; action = 'å·²å–æ¶ˆ'; }
                content = `### ${title}\n<font color="${color}">**${courseData.student}** çš„è¯¾ç¨‹${action}</font>\n\n**è€å¸ˆ**ï¼š${courseData.teacher}\n**è¯¾ç¨‹**ï¼š${courseData.course}\n**æ—¶é—´**ï¼š${courseData.date.substring(5)} (${weekDay}) ${courseData.startTime}-${courseData.endTime}\n${courseData.note ? `**å¤‡æ³¨**ï¼š${courseData.note}` : ''}`.trim();
            }

            try {
                await fetch('https://wxpusher.zjiecode.com/api/send/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appToken: WXPUSHER_APP_TOKEN, content: content, contentType: 3, uids: targetUids })
                });
                return { success: true };
            } catch (e) { return { success: false }; }
        };

        // --- æ ¸å¿ƒï¼šå†²çªæ£€æµ‹ ---
        const checkConflict = (newCourse, existingCourses) => {
            const ROOM_RULES = [
                { name: "ç´æˆ¿", keywords: ["é’¢ç´", "å£°ä¹"] }, 
                { name: "é¼“æˆ¿", keywords: ["æ¶å­é¼“", "é¼“"] }  
            ];
            const getRoomName = (courseName) => {
                if (!courseName) return null;
                for (let rule of ROOM_RULES) {
                    if (rule.keywords.some(k => courseName.includes(k))) return rule.name;
                }
                return null;
            };
            const currentRoom = getRoomName(newCourse.course);
            if (!currentRoom) return null; 

            const timeToNum = (t) => {
                if (!t) return -1;
                const [h, m] = t.split(/[:ï¼š]/).map(Number);
                return h + (m || 0)/60;
            };
            const newStart = timeToNum(newCourse.startTime);
            const newEnd = timeToNum(newCourse.endTime);

            const normalizeDate = (d) => {
                const dateObj = new Date(d);
                dateObj.setHours(0, 0, 0, 0); 
                return dateObj.getTime();
            };
            const targetDateTs = normalizeDate(newCourse.date);

            for (let app of existingCourses) {
                if (app.id === newCourse.id) continue; 
                if (normalizeDate(app.date) !== targetDateTs) continue; 

                const appCourseName = app.course || app.subject || "";
                const appRoom = getRoomName(appCourseName);
                
                if (appRoom === currentRoom) {
                    const appStart = timeToNum(app.startTime);
                    const appEnd = timeToNum(app.endTime);
                    if (newStart < appEnd && appStart < newEnd) {
                        return { ...app, course: appCourseName, roomName: currentRoom };
                    }
                }
            }
            return null;
        };

        // --- å›¾æ ‡ ---
        const Icons = {
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Plus: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Music: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>,
            X: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Settings: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            LogOut: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            FileText: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            Clock: ({size=12}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            Trash2: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
            Filter: ({size=32}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
            List: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            Grid: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            AlertCircle: ({size=10}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>,
            Edit3: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            Wifi: ({size=10}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>,
            Check: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            Share: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>,
            Bell: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>,
            AlertTriangle: ({size=48}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        };

        const generateTimeOptions = (startHour, endHour) => {
            const times = [];
            for (let h = startHour; h <= endHour; h++) {
                times.push(`${h.toString().padStart(2, '0')}:00`);
                times.push(`${h.toString().padStart(2, '0')}:15`);
                times.push(`${h.toString().padStart(2, '0')}:30`);
                times.push(`${h.toString().padStart(2, '0')}:45`);
            }
            return times;
        };

        const formatLocalDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getTargetDate = (text, baseDate = new Date()) => {
            const today = new Date(baseDate);
            today.setHours(0,0,0,0);
            const currentYear = today.getFullYear();
            if (text.includes('æ˜å¤©')) return new Date(today.getTime() + 86400000);
            if (text.includes('åå¤©')) return new Date(today.getTime() + 86400000 * 2);
            if (text.includes('ä»Šå¤©')) return today;
            const dateMatch = text.match(/(\d{1,2})[æœˆ\.](\d{1,2})[æ—¥å·]?/);
            if (dateMatch) {
                const m = parseInt(dateMatch[1]) - 1;
                const d = parseInt(dateMatch[2]);
                const target = new Date(currentYear, m, d);
                if (today.getMonth() === 11 && m === 0) target.setFullYear(currentYear + 1);
                return target;
            }
            const dayMatch = text.match(/(\d{1,2})[æ—¥å·]/);
            if (dayMatch) {
                const d = parseInt(dayMatch[1]);
                const target = new Date(currentYear, today.getMonth(), d);
                if (d < today.getDate() && (today.getDate() - d > 7)) target.setMonth(today.getMonth() + 1);
                return target;
            }
            const weekMatch = text.match(/[å‘¨æ˜ŸæœŸ]([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/);
            if (weekMatch) {
                const map = { 'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6, 'æ—¥':0, 'å¤©':0 };
                const targetDay = map[weekMatch[1]];
                const currentDay = today.getDay();
                let diff = targetDay - currentDay;
                if (diff < 0) diff += 7; 
                if (text.includes('ä¸‹å‘¨') || text.includes('ä¸‹ä¸ª')) diff += 7;
                return new Date(today.getTime() + diff * 86400000);
            }
            return today;
        };

        function App() {
            const [schoolCode, setSchoolCode] = useState(() => localStorage.getItem('valley_code_v9') || '');
            const [inputCode, setInputCode] = useState('');
            const [notification, setNotification] = useState(null); 
            const [netStatus, setNetStatus] = useState('init');
            const [appointments, setAppointments] = useState([]);
            const [sysConfig, setSysConfig] = useState({ teachers: DEFAULT_TEACHERS, ...INITIAL_SETTINGS });
            const [currentDate, setCurrentDate] = useState(new Date());
            const [viewMode, setViewMode] = useState('grid'); 
            const [modalMode, setModalMode] = useState('closed'); 
            const [selectedTeacher, setSelectedTeacher] = useState('å…¨éƒ¨');
            // âœ¨ æ–°å¢ï¼šè¯¾ç¨‹ç±»å‹ç­›é€‰çŠ¶æ€ âœ¨
            const [filterType, setFilterType] = useState('all'); // all, formal, trial

            const [logoutConfirm, setLogoutConfirm] = useState(false);
            const [deleteConfirm, setDeleteConfirm] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [formData, setFormData] = useState({ id: null, student: '', course: COURSE_OPTIONS[0], teacher: '', startTime: '', endTime: '', note: '', date: '' });
            const [importText, setImportText] = useState('');
            const [parsedResults, setParsedResults] = useState([]);
            const [notifyData, setNotifyData] = useState(null);
            const [conflictData, setConflictData] = useState(null);

            // è®¤è¯ä¸åŒæ­¥
            useEffect(() => {
                if (!isFirebaseReady) { setNetStatus('disconnected'); return; }
                const autoLogin = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         try { await auth.signInWithCustomToken(__initial_auth_token); return; } catch(e) {}
                    }
                    try { await auth.signInAnonymously(); } catch(e) { console.error("Login Error", e); }
                };
                autoLogin();
                return auth.onAuthStateChanged(user => {
                    if (user) { setNetStatus('connected'); if(schoolCode) startSync(schoolCode); } 
                    else { setNetStatus('disconnected'); }
                });
            }, [schoolCode]);

            const getCollection = (code) => {
                if (typeof __app_id !== 'undefined') return db.collection('artifacts').doc(__app_id).collection('public').doc('data').collection(`${code}_data`);
                else return db.collection(`${code}_data`);
            };

            const startSync = (code) => {
                getCollection(code).onSnapshot(snapshot => {
                    const apps = []; let settings = null;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.type === 'sys_settings') settings = data;
                        else apps.push({ id: doc.id, ...data });
                    });
                    apps.sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));
                    setAppointments(apps);
                    if (settings) {
                         let loadedTeachers = settings.teachers || DEFAULT_TEACHERS;
                         loadedTeachers = loadedTeachers.map(tStr => {
                             const name = tStr.split(':')[0].trim();
                             const better = DEFAULT_TEACHERS.find(dt => dt.startsWith(name + ':'));
                             if (better && !tStr.includes(':')) return better;
                             return tStr;
                         });
                         setSysConfig({ 
                             teachers: loadedTeachers,
                             startHour: settings.startHour || 9,
                             endHour: settings.endHour || 22 
                         });
                    }
                }, error => {
                    if(error.code === 'permission-denied') showNotify("åŒæ­¥å¤±è´¥: è¯·æ£€æŸ¥Firebase Rules", 'error');
                    else showNotify("åŒæ­¥æ–­å¼€", 'error');
                });
            };

            const showNotify = (msg, type = 'success') => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 4000); };
            const handleLogin = (e) => { e.preventDefault(); if (!inputCode.trim()) return; setSchoolCode(inputCode.trim()); localStorage.setItem('valley_code_v9', inputCode.trim()); };
            const handleLogout = () => { if(!logoutConfirm) { setLogoutConfirm(true); setTimeout(()=>setLogoutConfirm(false), 3000); return; } setSchoolCode(''); setInputCode(''); setLogoutConfirm(false); };

            const getTeacherUid = (teacherName) => {
                const fullStr = sysConfig.teachers.find(s => {
                    const namePart = s.split(':')[0].trim();
                    return namePart === teacherName;
                });
                if(fullStr && fullStr.includes(':')) {
                    return fullStr.split(':')[1].trim();
                }
                return null;
            };

            const handleTestPush = async () => {
                showNotify("æ­£åœ¨æµ‹è¯•æ¨é€...");
                const result = await sendWxPush('test');
                if (!result.success) {
                    alert("âŒ æ¨é€å¤±è´¥:\n" + result.msg);
                } else {
                    alert("âœ… æ¨é€æˆåŠŸï¼\nè¯·æ£€æŸ¥å¾®ä¿¡æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯ã€‚");
                }
            };

            const handleSaveClick = () => {
                if (!formData.student || !formData.course) { showNotify("è¯·å¡«å†™å®Œæ•´", 'error'); return; }
                const conflict = checkConflict({ ...formData, date: formData.date || formatLocalDate(currentDate) }, appointments);
                if (conflict) { setConflictData(conflict); } else { executeSave(false); }
            };

            const executeSave = async (isForceSave) => {
                if (!schoolCode) return;
                setIsSaving(true);
                setConflictData(null); 
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("ç½‘ç»œè¯·æ±‚è¶…æ—¶")), 8000));
                
                try {
                    const saveData = { ...formData, date: formData.date || formatLocalDate(currentDate) };
                    delete saveData.id;
                    const colRef = getCollection(schoolCode);
                    const savePromise = formData.id ? colRef.doc(formData.id).update(saveData) : colRef.add({ ...saveData, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    await Promise.race([savePromise, timeoutPromise]);
                    const isEdit = !!formData.id;
                    showNotify(isEdit ? "ä¿®æ”¹æˆåŠŸ" : "æ·»åŠ æˆåŠŸ");
                    setModalMode('closed');
                    const tUid = getTeacherUid(saveData.teacher);
                    showNotify("æ­£åœ¨æ¨é€é€šçŸ¥...", 'success');
                    const pushed = await sendWxPush(saveData, isEdit ? 'edit' : 'add', tUid);
                    if(pushed) showNotify("æ¨é€æˆåŠŸï¼"); else setNotifyData(saveData);
                } catch (e) {
                    let msg = e.message;
                    if(msg.includes("permission-denied")) msg = "ä¿å­˜è¢«æ‹’ç»: è¯·æ£€æŸ¥æ•°æ®åº“Rules";
                    showNotify(msg, 'error');
                } finally { setIsSaving(false); }
            };

            const handleDelete = async () => {
                if (!deleteConfirm) { setDeleteConfirm(true); return; }
                if (!formData.id) return;
                setIsSaving(true);
                try {
                    const colRef = getCollection(schoolCode);
                    await colRef.doc(formData.id).delete();
                    showNotify("åˆ é™¤æˆåŠŸ");
                    setModalMode('closed');
                    setDeleteConfirm(false);
                    const tUid = getTeacherUid(formData.teacher);
                    showNotify("æ­£åœ¨æ¨é€åˆ é™¤é€šçŸ¥...", 'success');
                    await sendWxPush(formData, 'delete', tUid);
                } catch(e) { showNotify("åˆ é™¤å¤±è´¥", 'error'); } finally { setIsSaving(false); }
            };

            const copyNotification = () => {
                if (!notifyData) return;
                const d = new Date(notifyData.date);
                const weekDay = d.toLocaleDateString('zh-CN', {weekday:'long'});
                const text = `ã€æ’è¯¾é€šçŸ¥ã€‘\nğŸ“… æ—¥æœŸï¼š${notifyData.date.substring(5)} (${weekDay})\nâ° æ—¶é—´ï¼š${notifyData.startTime} - ${notifyData.endTime}\nğŸ‘©â€ğŸ« è€å¸ˆï¼š${notifyData.teacher}\nğŸ¸ è¯¾ç¨‹ï¼š${notifyData.course}\nğŸ‘¤ å­¦å‘˜ï¼š${notifyData.student}${notifyData.note ? `\nğŸ“ å¤‡æ³¨ï¼š${notifyData.note}` : ''}`;
                navigator.clipboard.writeText(text).then(() => { alert("é€šçŸ¥æ–‡æ¡ˆå·²å¤åˆ¶ï¼"); setNotifyData(null); });
            };

            const saveSettings = async (newTeachers) => {
                setIsSaving(true);
                try {
                    await getCollection(schoolCode).doc('settings').set({ type: 'sys_settings', teachers: newTeachers, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                    showNotify("è®¾ç½®å·²ä¿å­˜"); setModalMode('closed');
                } catch(e) { showNotify("ä¿å­˜å¤±è´¥", 'error'); } finally { setIsSaving(false); }
            };

            // --- æ™ºèƒ½å¯¼å…¥é€»è¾‘ (å½»åº•ä¿®å¤ç‰ˆ) ---
            const parseImportText = () => {
                if (!importText.trim()) { showNotify("å†…å®¹ä¸ºç©º", 'error'); return; }
                try {
                    // 1. æ ‡ç‚¹ç²‰ç¢ï¼šæŠŠæ‰€æœ‰æ ‡ç‚¹å’Œæ¢è¡Œéƒ½å˜æˆç©ºæ ¼ï¼Œæ–¹ä¾¿åˆ‡å‰²
                    let raw = importText.replace(/[ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿã€,;!?: \n]/g, ' ');
                    const lines = [raw]; // ä½œä¸ºä¸€ä¸ªé•¿å¥å¤„ç†ï¼Œæˆ–è€…æŒ‰ç©ºè¡Œåˆ†å‰²ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†é€»è¾‘
                    // æ›´å¥½çš„æ–¹å¼ï¼šä¾ç„¶æŒ‰æ¢è¡Œç¬¦åˆç­›ï¼Œä½†å…¼å®¹æ€§æ›´å¥½
                    const rawLines = importText.split('\n').filter(l => l.trim().length > 1);
                    const res = [];
                    
                    rawLines.forEach(line => {
                        let temp = line.replace(/[ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿã€,;!?: ]/g, ' '); // å•è¡Œå†æ¬¡æ¸…æ´—

                        // 2. æå–æ—¥æœŸ
                        const dateObj = getTargetDate(line, new Date());
                        const dateStr = formatLocalDate(dateObj);
                        const today = new Date(); today.setHours(0,0,0,0);
                        const isPast = new Date(dateObj) < today;
                        
                        // 3. æå–è€å¸ˆ
                        let t = sysConfig.teachers[0].split(':')[0]; let tFound = false;
                        const sortedT = [...sysConfig.teachers].sort((a,b) => b.length - a.length);
                        for (let teaStr of sortedT) { 
                            const teaName = teaStr.split(':')[0].trim();
                            const short = teaName.replace('è€å¸ˆ',''); 
                            if (temp.includes(teaName)) { t = teaName; tFound = true; break; } 
                            else if (temp.includes(short)) { t = teaName; tFound = true; break; } 
                        }
                        if(!tFound && selectedTeacher !== 'å…¨éƒ¨') t = selectedTeacher;

                        // 4. æå–æ—¶é—´
                        let startT = '', endT = '';
                        // åŒ¹é… 14:00 æˆ– 14ç‚¹30
                        const rangeMatch = temp.match(/(\d{1,2})[:ç‚¹](\d{0,2})/);
                        if (rangeMatch) {
                            let h = parseInt(rangeMatch[1]);
                            let m = parseInt(rangeMatch[2] || '0');
                            
                            // ä¸‹åˆåˆ¤æ–­é€»è¾‘
                            if(h>=1 && h<=7 && !temp.includes('ä¸Šåˆ') && !temp.includes('am')) h += 12;
                            if((temp.includes('ä¸‹åˆ')||temp.includes('æ™šä¸Š')) && h<12) h += 12;

                            startT = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                            endT = `${(h+1).toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                        }

                        // 5. æå–è¯¾ç¨‹ (æ¨¡ç³ŠåŒ¹é… + è‡ªåŠ¨å½’ç±»)
                        let c = COURSE_OPTIONS[0]; 
                        let cFound = false;
                        
                        // å…ˆè¯•æ ‡å‡†å
                        for (let standardC of COURSE_OPTIONS) {
                            if (temp.includes(standardC)) { c = standardC; cFound = true; break; }
                        }
                        // åè¯•æ¨¡ç³Šå
                        if (!cFound) {
                            if (temp.includes("é’¢ç´")) { c = temp.includes("ä½“éªŒ") ? "é’¢ç´ä½“éªŒè¯¾" : "é’¢ç´æ­£å¼è¯¾"; }
                            else if (temp.includes("å£°ä¹")) { c = temp.includes("ä½“éªŒ") ? "å£°ä¹ä½“éªŒè¯¾" : "å£°ä¹æ­£å¼è¯¾"; }
                            else if (temp.includes("æ¶å­é¼“") || temp.includes("é¼“")) { c = temp.includes("ä½“éªŒ") ? "æ¶å­é¼“ä½“éªŒè¯¾" : "æ¶å­é¼“æ­£å¼è¯¾"; }
                            else if (temp.includes("å‰ä»–")) { c = temp.includes("ä½“éªŒ") ? "å‰ä»–ä½“éªŒè¯¾" : "å‰ä»–æ­£å¼è¯¾"; }
                            // é»˜è®¤å½’ç±»
                            else if (temp.includes("ä½“éªŒ") || temp.includes("è¯•å¬")) { c = "é’¢ç´ä½“éªŒè¯¾"; } // é»˜è®¤ä½“éªŒ
                            else { c = "é’¢ç´æ­£å¼è¯¾"; } // é»˜è®¤æ­£å¼
                        }

                        // 6. æå–å­¦å‘˜ (æ’é™¤å¹²æ‰°è¯)
                        let s = "å­¦å‘˜"; 
                        // ç§»é™¤å·²çŸ¥å…³é”®è¯
                        let cleanTemp = temp.replace(dateObj.getDate()+'æ—¥', '').replace(dateObj.getMonth()+1+'æœˆ', '');
                        cleanTemp = cleanTemp.replace(/(æ˜å¤©|åå¤©|ä»Šå¤©|ä¸‹å‘¨|ä¸‹ä¸ª|è€å¸ˆ|ä¸Šè¯¾|æ’è¯¾|å®‰æ’|æ—¶é—´|è¯¾ç¨‹|am|pm|ä¸Šåˆ|ä¸‹åˆ|æ™šä¸Š|æ­£å¼è¯¾|ä½“éªŒè¯¾|è¾…å¯¼|é™ªç»ƒ|è¯•å¬|é’¢ç´|å£°ä¹|æ¶å­é¼“|å‰ä»–)/gi, '');
                        cleanTemp = cleanTemp.replace(/[0-9]/g, '').trim();
                        
                        // å¯»æ‰¾æœ€åƒåå­—çš„ç‰‡æ®µ
                        const parts = cleanTemp.split(' ').filter(p => p.trim().length > 1); // è‡³å°‘2ä¸ªå­—
                        if(parts.length > 0) s = parts[0].substring(0, 4);

                        if(startT) res.push({ date: dateStr, startTime: startT, endTime: endT, teacher: t, student: s, course: c, original: line, isPast });
                    });
                    setParsedResults(res);
                    if(res.length===0) showNotify("æœªè¯†åˆ«åˆ°æœ‰æ•ˆå†…å®¹", 'error'); else showNotify(`è¯†åˆ«å‡º ${res.length} æ¡`);
                } catch(e) { showNotify("è¯†åˆ«é”™è¯¯", 'error'); }
            };

            const confirmImport = async () => {
                if(parsedResults.length === 0) return;
                setIsSaving(true);
                try {
                    const batch = db.batch(); 
                    const colRef = getCollection(schoolCode);
                    parsedResults.forEach(({original, isPast, ...rest}) => {
                        const docRef = colRef.doc();
                        batch.set(docRef, { ...rest, note: "å¯¼å…¥: "+original, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    });
                    await batch.commit();
                    setModalMode('closed'); setParsedResults([]); setImportText(''); showNotify("å¯¼å…¥æˆåŠŸ");
                } catch(e) { 
                    if (e.code === 0 || e.code === -1) showNotify("å¯¼å…¥å¤±è´¥: è¯·é…ç½® Web å®‰å…¨åŸŸå", 'error');
                    else showNotify("å¯¼å…¥å¤±è´¥: " + e.message, 'error'); 
                } finally { setIsSaving(false); }
            };
            
            const openImportModal = () => { setModalMode('import'); setParsedResults([]); setImportText(''); };
            const closeImportModal = () => { setModalMode('closed'); setParsedResults([]); setImportText(''); };

            // è§†å›¾ (å¢åŠ  filterType é€»è¾‘)
            const dateString = formatLocalDate(currentDate);
            const dailyApps = useMemo(() => {
                return appointments
                    .filter(a => {
                        if (a.date !== dateString) return false;
                        if (selectedTeacher !== 'å…¨éƒ¨' && a.teacher !== selectedTeacher) return false;
                        // è¯¾ç¨‹ç±»å‹è¿‡æ»¤
                        if (filterType === 'formal' && !a.course.includes('æ­£å¼')) return false;
                        if (filterType === 'trial' && !a.course.includes('ä½“éªŒ')) return false;
                        return true;
                    })
                    .sort((a,b) => a.startTime.localeCompare(b.startTime));
            }, [appointments, dateString, selectedTeacher, filterType]);
            
            const upcomingApps = useMemo(() => {
                const today = formatLocalDate(new Date());
                return appointments
                    .filter(a => {
                        if (a.date < today) return false;
                        if (selectedTeacher !== 'å…¨éƒ¨' && a.teacher !== selectedTeacher) return false;
                        if (filterType === 'formal' && !a.course.includes('æ­£å¼')) return false;
                        if (filterType === 'trial' && !a.course.includes('ä½“éªŒ')) return false;
                        return true;
                    })
                    .sort((a,b) => a.date===b.date ? a.startTime.localeCompare(b.startTime) : a.date.localeCompare(b.date));
            }, [appointments, selectedTeacher, filterType]);

            if (!isFirebaseReady) return <div className="min-h-screen flex items-center justify-center p-6 text-red-500">Firebase åˆå§‹åŒ–å¤±è´¥</div>;

            if (!schoolCode) return (
                <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-6">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-sm text-center shadow-2xl">
                        <Icons.Music size={48} /><h1 className="text-2xl font-bold mt-4 mb-2">å±±è°·éŸ³ä¹ V11.2</h1>
                        <p className="text-gray-400 text-sm mb-6">æé€Ÿç­›é€‰Â·æ™ºèƒ½å¯¼å…¥ä¿®å¤</p>
                        <form onSubmit={handleLogin}><input value={inputCode} onChange={e=>setInputCode(e.target.value)} className="w-full border-b-2 border-purple-200 p-2 text-center text-xl font-bold outline-none mb-6 focus:border-purple-600" placeholder="è®¾ç½®å­¦æ ¡æš—å· (æˆ¿é—´å·)" autoFocus/><button className="w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg">è¿›å…¥ç³»ç»Ÿ</button></form>
                        <div className="mt-4 text-[10px] text-gray-400">è‹¥æ— æ³•ç™»å½•ï¼Œè¯·åœ¨Firebaseåå°æ·»åŠ NetlifyåŸŸåç™½åå•</div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col relative pb-safe">
                    {notification && <div className={`fixed top-0 left-0 right-0 z-[60] py-2 px-4 text-center text-white text-sm font-bold animate-slide-down ${notification.type==='error'?'bg-red-500':'bg-green-500'}`}>{notification.msg}</div>}
                    
                    <div className="bg-white shadow-sm sticky top-0 z-30">
                        <div className="bg-purple-700 text-white px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center font-bold text-lg"><span className="mr-2"><Icons.Music /></span>å±±è°·éŸ³ä¹
                                <span title={netStatus} className={`ml-2 w-2 h-2 rounded-full ${netStatus==='connected'?'bg-green-400':'bg-red-400'}`}></span>
                            </div>
                            <div className="flex gap-3 items-center">
                                <button onClick={openImportModal} className="p-2 bg-white/20 rounded-full"><Icons.FileText /></button>
                                <button onClick={()=>setModalMode('settings')} className="p-2 bg-white/20 rounded-full"><Icons.Settings /></button>
                                <button onClick={handleLogout} className={`flex items-center gap-1 px-3 py-1.5 rounded-full transition-all ${logoutConfirm?'bg-red-600 w-auto':'bg-red-500/80 w-9 h-9 justify-center'}`}>{logoutConfirm?<span className="text-xs whitespace-nowrap">ç¡®å®š?</span>:<Icons.LogOut />}</button>
                            </div>
                        </div>
                        
                        {/* è€å¸ˆç­›é€‰ */}
                        <div className="flex overflow-x-auto no-scrollbar bg-white border-b px-2 py-2 gap-2">
                            <span className="text-xs text-gray-400 font-bold flex-shrink-0 px-2 pt-1">è€å¸ˆ:</span>
                            <button onClick={()=>setSelectedTeacher('å…¨éƒ¨')} className={`flex-shrink-0 px-3 py-1 text-xs rounded-full border ${selectedTeacher==='å…¨éƒ¨'?'bg-gray-800 text-white':'bg-white text-gray-600'}`}>å…¨éƒ¨</button>
                            {sysConfig.teachers.map(t=>{
                                const nameOnly = t.split(':')[0]; 
                                return <button key={t} onClick={()=>setSelectedTeacher(nameOnly)} className={`flex-shrink-0 px-3 py-1 text-xs rounded-full border ${selectedTeacher===nameOnly?'bg-purple-600 text-white':'bg-white text-gray-600'}`}>{nameOnly}</button>
                            })}
                        </div>
                        
                        {/* âœ¨ æ–°å¢ï¼šè¯¾ç¨‹ç±»å‹ç­›é€‰ âœ¨ */}
                        <div className="flex overflow-x-auto no-scrollbar bg-white border-b px-2 py-1 gap-2 pb-2">
                            <span className="text-xs text-gray-400 font-bold flex-shrink-0 px-2 pt-1">ç±»å‹:</span>
                            <button onClick={()=>setFilterType('all')} className={`flex-shrink-0 px-3 py-0.5 text-xs rounded-full border ${filterType==='all'?'bg-blue-600 text-white':'bg-white text-gray-600'}`}>å…¨éƒ¨</button>
                            <button onClick={()=>setFilterType('formal')} className={`flex-shrink-0 px-3 py-0.5 text-xs rounded-full border ${filterType==='formal'?'bg-blue-600 text-white':'bg-white text-gray-600'}`}>æ­£å¼è¯¾</button>
                            <button onClick={()=>setFilterType('trial')} className={`flex-shrink-0 px-3 py-0.5 text-xs rounded-full border ${filterType==='trial'?'bg-blue-600 text-white':'bg-white text-gray-600'}`}>ä½“éªŒè¯¾</button>
                        </div>

                        {viewMode === 'grid' && (
                            <div className="flex justify-between items-center px-4 py-2 bg-gray-50 border-b">
                                <button onClick={()=>{const d=new Date(currentDate);d.setDate(d.getDate()-1);setCurrentDate(d)}} className="p-2 rounded-full hover:bg-gray-200"><Icons.ChevronLeft /></button>
                                <div className="text-center" onClick={()=>setCurrentDate(new Date())}><div className="font-bold text-lg">{formatLocalDate(currentDate).substring(5).replace('-','æœˆ')+'æ—¥'}</div><div className="text-xs text-purple-600 font-bold">{currentDate.toLocaleDateString('zh-CN',{weekday:'long'})}</div></div>
                                <button onClick={()=>{const d=new Date(currentDate);d.setDate(d.getDate()+1);setCurrentDate(d)}} className="p-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight /></button>
                            </div>
                        )}
                    </div>

                    <div className="flex-1 overflow-y-auto p-3 pb-24">
                        {viewMode === 'grid' ? (
                            <>
                                {dailyApps.length===0 && <div className="text-center py-10 text-gray-400 text-sm"><div className="flex justify-center mb-2 opacity-20"><Icons.Filter /></div>ä»Šå¤©æ²¡æœ‰è¯¾ç¨‹</div>}
                                {dailyApps.map(app => (
                                    <div key={app.id} onClick={()=>{setFormData(app);setDeleteConfirm(false);setModalMode('edit')}} className="bg-white p-3 mb-3 rounded-xl shadow-sm border-l-4 border-purple-500 active:scale-95 transition flex justify-between items-center">
                                        <div>
                                            <div className="flex items-center text-purple-700 font-bold mb-1"><span className="mr-1"><Icons.Clock /></span>{app.startTime}-{app.endTime}</div>
                                            <div className="font-bold text-gray-800 text-lg">{app.student}</div>
                                            <div className="text-xs text-gray-500 mt-1"><span className="bg-gray-100 px-1.5 py-0.5 rounded mr-2">{app.teacher}</span>{app.course || app.subject}</div>
                                            {app.note && <div className="text-xs text-gray-400 mt-1 truncate max-w-[200px]">{app.note}</div>}
                                        </div>
                                        <div className="text-gray-300"><Icons.Edit3 /></div>
                                    </div>
                                ))}
                                <div className="mt-6 border-t pt-4"><p className="text-xs text-gray-400 mb-2 text-center">ç‚¹å‡»æ—¶æ®µå¿«æ·æ·»åŠ </p><div className="grid grid-cols-4 gap-2">{[9,10,11,13,14,15,16,17,18,19,20].map(h=><button key={h} onClick={()=>{setFormData({id:null,student:'',course:COURSE_OPTIONS[0],teacher:selectedTeacher!=='å…¨éƒ¨'?selectedTeacher:sysConfig.teachers[0].split(':')[0],startTime:`${h}:00`,endTime:`${h+1}:00`,date:dateString,note:''});setDeleteConfirm(false);setModalMode('edit')}} className="bg-white border rounded py-2 text-xs text-gray-600 hover:bg-purple-50">{h}:00</button>)}</div></div>
                            </>
                        ) : (
                            <div className="space-y-4">
                                <h3 className="font-bold text-gray-700 flex items-center"><span className="mr-2"><Icons.Calendar size={18}/></span>æœªæ¥è¡Œç¨‹</h3>
                                {upcomingApps.length===0?<div className="text-center text-gray-400 py-10">æš‚æ— è¯¾ç¨‹</div>:upcomingApps.map((app,i)=>{
                                    const showH = i===0 || upcomingApps[i-1].date!==app.date;
                                    return <div key={app.id}>{showH&&<div className="bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-bold mt-4 mb-2 sticky top-0">{app.date}</div>}<div onClick={()=>{setFormData(app);setDeleteConfirm(false);setModalMode('edit')}} className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 mb-2 active:bg-gray-50"><div><div className="text-purple-600 font-bold text-xs">{app.startTime}-{app.endTime}</div><div className="font-bold text-gray-800">{app.student} <span className="font-normal text-xs text-gray-500">({app.course || app.subject})</span></div><div className="text-xs bg-gray-100 inline-block px-1 rounded mt-1">{app.teacher}</div></div></div></div>
                                })}
                            </div>
                        )}
                    </div>

                    <div className="bg-white border-t p-2 flex justify-around text-xs text-gray-500 sticky bottom-0 z-40 pb-safe">
                        <button onClick={()=>setViewMode('grid')} className={`flex flex-col items-center p-2 ${viewMode==='grid'?'text-purple-600 font-bold':''}`}><Icons.Grid className="mb-1"/>æ—¥è§†å›¾</button>
                        <div className="relative -top-6"><button onClick={()=>{setFormData({id:null,student:'',course:COURSE_OPTIONS[0],teacher:selectedTeacher!=='å…¨éƒ¨'?selectedTeacher:sysConfig.teachers[0].split(':')[0],startTime:'09:00',endTime:'10:00',date:dateString,note:''});setDeleteConfirm(false);setModalMode('edit')}} className="w-14 h-14 bg-purple-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-purple-700"><Icons.Plus size={28}/></button></div>
                        <button onClick={()=>setViewMode('list')} className={`flex flex-col items-center p-2 ${viewMode==='list'?'text-purple-600 font-bold':''}`}><Icons.List className="mb-1"/>æœªæ¥è¡Œç¨‹</button>
                    </div>

                    {modalMode==='edit' && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center">
                            <div className="bg-white w-full sm:max-w-md p-6 rounded-t-2xl sm:rounded-2xl animate-slide-up">
                                <h3 className="font-bold text-lg mb-4 flex justify-between">{formData.id?'ç¼–è¾‘':'æ–°å¢'}<button onClick={()=>setModalMode('closed')} className="text-gray-400"><Icons.X /></button></h3>
                                <div className="space-y-3">
                                    <input type="date" value={formData.date} onChange={e=>setFormData({...formData,date:e.target.value})} className="w-full p-2 bg-gray-100 rounded"/>
                                    <div className="flex gap-2"><select value={formData.startTime} onChange={e=>setFormData({...formData,startTime:e.target.value})} className="flex-1 p-2 bg-gray-100 rounded font-bold">{generateTimeOptions(9,22).map(t=><option key={t} value={t}>{t}</option>)}</select><select value={formData.endTime} onChange={e=>setFormData({...formData,endTime:e.target.value})} className="flex-1 p-2 bg-gray-100 rounded font-bold">{generateTimeOptions(9,22).map(t=><option key={t} value={t}>{t}</option>)}</select></div>
                                    <select value={formData.teacher} onChange={e=>setFormData({...formData,teacher:e.target.value})} className="w-full p-2 bg-gray-100 rounded font-bold">{sysConfig.teachers.map(t=>{ const name=t.split(':')[0]; return <option key={t} value={name}>{name}</option>})}</select>
                                    <input placeholder="å­¦å‘˜å§“å" value={formData.student} onChange={e=>setFormData({...formData,student:e.target.value})} className="w-full p-3 border rounded font-bold"/>
                                    {/* å‡çº§ï¼šè¯¾ç¨‹é€‰æ‹©ä¸‹æ‹‰èœå• */}
                                    <select value={formData.course} onChange={e=>setFormData({...formData,course:e.target.value})} className="w-full p-3 border rounded font-bold bg-white">
                                        {COURSE_OPTIONS.map(c=><option key={c} value={c}>{c}</option>)}
                                    </select>
                                    <input placeholder="å¤‡æ³¨" value={formData.note} onChange={e=>setFormData({...formData,note:e.target.value})} className="w-full p-3 border rounded text-sm"/>
                                    <div className="flex gap-3 mt-4">
                                        {formData.id && <button onClick={handleDelete} className={`flex-1 py-3 rounded-lg font-bold border ${deleteConfirm?'bg-red-600 text-white':'text-red-500 bg-red-50 border-red-100'}`}>{deleteConfirm?'ç¡®å®šåˆ é™¤?':'åˆ é™¤'}</button>}
                                        <button onClick={handleSaveClick} disabled={isSaving} className="flex-[2] py-3 bg-purple-600 text-white rounded-lg font-bold">{isSaving?'ä¿å­˜ä¸­...':'ä¿å­˜'}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* âœ¨âœ¨âœ¨ æ–°å¢ï¼šå†²çªè­¦å‘Šå¼¹çª— âœ¨âœ¨âœ¨ */}
                    {conflictData && (
                        <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-shake text-center relative border-t-4 border-red-500">
                                <div className="text-red-500 mb-3 flex justify-center"><Icons.AlertTriangle size={48} /></div>
                                <h3 className="text-xl font-bold mb-1 text-gray-800">æ’è½¦äº†ï¼</h3>
                                <p className="text-sm text-gray-500 mb-4">è¯¾å®¤ã€{conflictData.roomName}ã€‘å·²è¢«å ç”¨</p>
                                
                                <div className="bg-red-50 p-4 rounded-xl text-left text-sm mb-6 border border-red-100">
                                    <div className="flex items-center justify-between mb-2 pb-2 border-b border-red-100">
                                        <span className="font-bold text-gray-600">å†²çªè¯¾ç¨‹ï¼š</span>
                                        <span className="text-red-600 font-bold text-lg">{conflictData.startTime}-{conflictData.endTime}</span>
                                    </div>
                                    <div className="space-y-1 text-gray-700">
                                        <p>ğŸ‘©â€ğŸ« è€å¸ˆï¼š{conflictData.teacher}</p>
                                        <p>ğŸ‘¤ å­¦å‘˜ï¼š{conflictData.student}</p>
                                        <p>ğŸ¸ è¯¾ç¨‹ï¼š{conflictData.course}</p>
                                    </div>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={()=>setConflictData(null)} className="flex-1 py-3 rounded-xl font-bold bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors">
                                        è¿”å›ä¿®æ”¹
                                    </button>
                                    <button onClick={()=>executeSave(true)} className="flex-1 py-3 rounded-xl font-bold bg-red-500 hover:bg-red-600 text-white shadow-lg transition-transform active:scale-95">
                                        å¼ºåˆ¶ä¿å­˜
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {modalMode==='import' && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 flex flex-col max-h-[85vh]">
                                <h3 className="font-bold text-lg mb-2">æ™ºèƒ½å¯¼å…¥ V11.2</h3>
                                <textarea value={importText} onChange={e=>setImportText(e.target.value)} className="w-full h-32 border p-3 rounded" placeholder="ç²˜è´´æ–‡æœ¬..."/>
                                <button onClick={parseImportText} className="w-full bg-purple-600 text-white py-2 rounded mt-3 font-bold">å¼€å§‹è¯†åˆ«</button>
                                <button onClick={closeImportModal} className="absolute top-4 right-4"><Icons.X /></button>
                            </div>
                        </div>
                    )}
                    
                    {modalMode==='settings' && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6">
                                <h3 className="font-bold text-lg mb-4">è®¾ç½®</h3>
                                <p className="text-xs text-gray-400 mb-2">æ ¼å¼ï¼šè€å¸ˆåå­—:UID (å¯é€‰)<br/>ä¾‹å¦‚ï¼šéƒ­è€å¸ˆ:UID_12345, é’±è€å¸ˆ</p>
                                <textarea value={sysConfig.teachers.join(',')} onChange={e=>setSysConfig({...sysConfig,teachers:e.target.value.split(',')})} className="w-full p-3 border rounded h-24 text-sm mb-4"/>
                                <button onClick={handleTestPush} className="w-full border border-green-500 text-green-600 py-3 rounded font-bold mb-3 flex items-center justify-center"><Icons.Bell className="mr-2"/> æµ‹è¯•æ¨é€ (Admin)</button>
                                <button onClick={()=>saveSettings(sysConfig.teachers)} className="w-full bg-purple-600 text-white py-3 rounded font-bold">ä¿å­˜è®¾ç½®</button>
                                <button onClick={()=>setModalMode('closed')} className="w-full text-gray-400 py-2 mt-2">å…³é—­</button>
                            </div>
                        </div>
                    )}

                    {/* é€šçŸ¥å¼¹çª— (è‡ªåŠ¨æ¨é€å¤±è´¥æˆ–æœªé…ç½®æ—¶æ˜¾ç¤º) */}
                    {notifyData && (
                        <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-bounce-in text-center relative">
                                <button onClick={()=>setNotifyData(null)} className="absolute top-4 right-4 text-gray-400"><Icons.X /></button>
                                <div className="text-green-500 mb-2 flex justify-center"><Icons.Check size={48} /></div>
                                <h3 className="text-xl font-bold mb-1">æ’è¯¾æˆåŠŸï¼</h3>
                                <p className="text-sm text-gray-500 mb-6">è¦é€šçŸ¥è€å¸ˆå—ï¼Ÿ</p>
                                <div className="bg-gray-50 p-4 rounded-xl text-left text-sm mb-6 border border-gray-100 shadow-inner">
                                    <div className="font-bold text-gray-700 mb-1">ã€æ’è¯¾é€šçŸ¥ã€‘</div>
                                    <div className="text-gray-600 space-y-1">
                                        <p>ğŸ“… æ—¥æœŸï¼š{notifyData.date.substring(5)} ({new Date(notifyData.date).toLocaleDateString('zh-CN', {weekday:'long'})})</p>
                                        <p>â° æ—¶é—´ï¼š{notifyData.startTime} - {notifyData.endTime}</p>
                                        <p>ğŸ‘©â€ğŸ« è€å¸ˆï¼š{notifyData.teacher}</p>
                                        <p>ğŸ¸ è¯¾ç¨‹ï¼š{notifyData.course}</p>
                                        <p>ğŸ‘¤ å­¦å‘˜ï¼š{notifyData.student}</p>
                                    </div>
                                </div>
                                <button onClick={copyNotification} className="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center transition-transform active:scale-95">
                                    <Icons.Share className="mr-2" /> å¤åˆ¶é€šçŸ¥å‘ç»™è€å¸ˆ
                                </button>
                                <button onClick={()=>setNotifyData(null)} className="w-full text-gray-400 py-3 mt-2 text-sm">æš‚ä¸é€šçŸ¥</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>